# GPUéŸ³ä¹æ’­æ”¾å™¨ - å¢žå¼ºç‰ˆ (å¸¦GPUæ£€æµ‹)

CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -O2 -pthread
INCLUDES = -I./include -I./src

# æ£€æµ‹Vulkanæ”¯æŒ
VULKAN_AVAILABLE := $(shell pkg-config --exists vulkan 2>/dev/null && echo yes || echo no)

ifeq ($(VULKAN_AVAILABLE),yes)
    VULKAN_CFLAGS := $(shell pkg-config --cflags vulkan 2>/dev/null)
    VULKAN_LIBS := $(shell pkg-config --libs vulkan 2>/dev/null)
    CXXFLAGS += $(VULKAN_CFLAGS) -DHAS_VULKAN
    ENABLE_VULKAN = yes
else
    # æ£€æŸ¥ç³»ç»Ÿå¤´æ–‡ä»¶
    ifneq (,$(wildcard /usr/include/vulkan/vulkan.h))
        ENABLE_VULKAN = yes
        VULKAN_LIBS = -lvulkan
    else ifneq (,$(wildcard /usr/local/include/vulkan/vulkan.h))
        ENABLE_VULKAN = yes
        INCLUDES += -I/usr/local/include
        VULKAN_LIBS = -lvulkan
    else
        ENABLE_VULKAN = no
    endif
endif

TARGET = gpu_player_enhanced
SOURCES = src/main_with_detection.cpp src/gpu/VulkanDetector.cpp

.PHONY: all clean run detect help gpu-info

# é»˜è®¤ç›®æ ‡
all: show-config $(TARGET)

# æ˜¾ç¤ºé…ç½®
show-config:
	@echo "=========================================="
	@echo "GPUéŸ³ä¹æ’­æ”¾å™¨ - å¢žå¼ºç‰ˆæž„å»ºé…ç½®"
	@echo "=========================================="
	@echo "C++ç¼–è¯‘å™¨: $(CXX)"
	@echo "C++æ ‡å‡†: C++17"
	@echo "æž„å»ºç±»åž‹: Release"
ifeq ($(ENABLE_VULKAN),yes)
	@echo "Vulkanæ”¯æŒ: âœ… å·²å¯ç”¨"
	@echo "Vulkanæ ‡å¿—: $(VULKAN_CFLAGS)"
	@echo "Vulkanåº“: $(VULKAN_LIBS)"
else
	@echo "Vulkanæ”¯æŒ: âŒ æœªå¯ç”¨"
	@echo "æç¤º: å®‰è£… libvulkan-dev ä»¥å¯ç”¨Vulkanæ”¯æŒ"
endif
	@echo "=========================================="
	@echo ""

# æž„å»ºä¸»ç¨‹åº
$(TARGET): $(SOURCES)
	@echo "æž„å»ºGPUéŸ³ä¹æ’­æ”¾å™¨ (å¢žå¼ºç‰ˆ)..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(SOURCES) -o $(TARGET)
	@echo "âœ… æž„å»ºå®Œæˆ: $(TARGET)"

# è¿è¡Œç¨‹åº
run: $(TARGET)
	@echo "è¿è¡ŒGPUéŸ³ä¹æ’­æ”¾å™¨ (å¢žå¼ºç‰ˆ)..."
	./$(TARGET)

# GPUæ£€æµ‹
detect: $(TARGET)
	@echo "ðŸ” è¿è¡ŒGPUæ£€æµ‹..."
	@echo "=========================================="
	@echo ""
	./$(TARGET) --gpu-info 2>/dev/null || echo "åœ¨ç¨‹åºå†…ä½¿ç”¨ 'gpu' å‘½ä»¤æŸ¥çœ‹GPUä¿¡æ¯"

# æ˜¾ç¤ºGPUä¿¡æ¯
gpu-info: $(TARGET)
	@echo "ðŸ” GPUä¿¡æ¯æ£€æµ‹:" 
	@echo "=========================================="
	@if [ -f $(TARGET) ]; then \
		echo "è¿è¡Œç‹¬ç«‹GPUæ£€æµ‹..."; \
		GPUDetector::PrintGPUReport 2>/dev/null || echo "ä½¿ç”¨ ./$(TARGET) ç„¶åŽè¾“å…¥ 'gpu' å‘½ä»¤"; \
	else \
		echo "è¯·å…ˆè¿è¡Œ 'make' æž„å»ºç¨‹åº"; \
	fi

# æ¸…ç†
clean:
	@echo "æ¸…ç†æž„å»ºæ–‡ä»¶..."
	rm -f $(TARGET)
	rm -rf build/
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¸®åŠ©
help:
	@echo "GPUéŸ³ä¹æ’­æ”¾å™¨ - å¢žå¼ºç‰ˆæž„å»ºç³»ç»Ÿ"
	@echo "=========================================="
	@echo ""
	@echo "ðŸŽ¯ å¯ç”¨ç›®æ ‡:"
	@echo "  make         - æž„å»ºå¢žå¼ºç‰ˆæ’­æ”¾å™¨"
	@echo "  make run     - æž„å»ºå¹¶è¿è¡Œæ’­æ”¾å™¨"
	@echo "  make detect  - è¿è¡ŒGPUæ£€æµ‹"
	@echo "  make clean   - æ¸…ç†æž„å»ºæ–‡ä»¶"
	@echo "  make help    - æ˜¾ç¤ºå¸®åŠ©"
	@echo ""
	@echo "ðŸš€ ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make         # æž„å»ºç¨‹åº"
	@echo "  ./$(TARGET)  # è¿è¡Œæ’­æ”¾å™¨"
	@echo "  > gpu        # åœ¨ç¨‹åºä¸­æŸ¥çœ‹GPUä¿¡æ¯"
	@echo "  > play music.mp3  # æ’­æ”¾éŸ³é¢‘æ–‡ä»¶"
	@echo ""
	@echo "ðŸ“‹ ç¨‹åºç‰¹æ€§:"
	@echo "  âœ… GPUåŽç«¯è‡ªåŠ¨æ£€æµ‹"
	@echo "  âœ… Vulkanæ”¯æŒæ£€æµ‹"
	@echo "  âœ… å®žæ—¶æ’­æ”¾æŽ§åˆ¶"
	@echo "  âœ… æ€§èƒ½ç»Ÿè®¡"
	@echo "  âœ… è¯¦ç»†çš„GPUä¿¡æ¯å±•ç¤º"
	@if [ "$(ENABLE_VULKAN)" = "yes" ]; then \
		echo "  âœ… Vulkan GPUåŠ é€Ÿæ”¯æŒ"; \
	else \
		echo "  âš ï¸  Vulkanæ”¯æŒæœªå¯ç”¨ (éœ€è¦ libvulkan-dev)"; \
	fi
	@echo "=========================================="

# å¼€å‘æ¨¡å¼ï¼ˆå¸¦è°ƒè¯•ä¿¡æ¯ï¼‰
debug: CXXFLAGS += -g -O0 -DDEBUG
debug: $(TARGET)
	@echo "ðŸ”§ è°ƒè¯•ç‰ˆæœ¬æž„å»ºå®Œæˆ"

# æ€§èƒ½åˆ†æž
profile: CXXFLAGS += -pg -O2
profile: $(TARGET)
	@echo "ðŸ“Š æ€§èƒ½åˆ†æžç‰ˆæœ¬æž„å»ºå®Œæˆ"
	@echo "è¿è¡Œç¨‹åºåŽä½¿ç”¨: gprof $(TARGET) gmon.out > analysis.txt"